#include <stdio.h>     // Librería para entrada y salida (printf, scanf, fgets)
#include <string.h>    // Librería para manejo de cadenas (strcmp, strcpy, strcspn)

#define MAX_LIBROS 10  // Máximo número de libros permitidos


// La estructura Libro agrupa todos los datos relacionados a un libro.
// typedef permite usar simplemente "Libro" como nombre del tipo.
typedef struct {
    int id;                 // ID único del libro
    char titulo[100];       // Título del libro
    char autor[50];         // Nombre del autor
    int anio;               // Año de publicación
    char estado[15];        // "Disponible" o "Prestado"
    int ocupado;            // 1 si el espacio está usado, 0 si está libre
} Libro;


// Sirven para que main pueda usar las funciones aunque estén definidas después.
int existeID(Libro *libros, int id);
void agregarLibro(Libro *libros);
void mostrarLibros(Libro *libros);
void buscarLibro(Libro *libros);
void actualizarEstado(Libro *libros);
void eliminarLibro(Libro *libros);


int main() {
    Libro libros[MAX_LIBROS] = {0};  // Arreglo de estructuras, inicializado en 0
    int opcion;

    // Ciclo principal del menú
    do {
        printf("\n--- Biblioteca ---\n");
        printf("1. Agregar libro\n");
        printf("2. Mostrar libros\n");
        printf("3. Buscar libro\n");
        printf("4. Actualizar estado\n");
        printf("5. Eliminar libro\n");
        printf("6. Salir\n");
        printf("Opcion: ");
        scanf("%d", &opcion);

        getchar(); // limpia el ENTER que queda en el buffer

        switch(opcion) {
            case 1: agregarLibro(libros); break;
            case 2: mostrarLibros(libros); break;
            case 3: buscarLibro(libros); break;
            case 4: actualizarEstado(libros); break;
            case 5: eliminarLibro(libros); break;
            case 6: printf("Saliendo...\n"); break;
            default: printf("Opción no válida.\n");
        }

    } while(opcion != 6);

    return 0;
}


// Revisa si un ID ya fue registrado antes.
// Devuelve 1 si existe, 0 si no existe.
int existeID(Libro *libros, int id) {
    for (int i = 0; i < MAX_LIBROS; i++) {
        // Si la posición está ocupada y el ID coincide
        if (libros[i].ocupado && libros[i].id == id)
            return 1;
    }
    return 0;
}


// Busca un espacio libre y registra un nuevo libro.
// Usa punteros para modificar directamente el arreglo original.
void agregarLibro(Libro *libros) {
    int index = -1;

    // Buscar una posición libre en el arreglo
    for (int i = 0; i < MAX_LIBROS; i++) {
        if (!libros[i].ocupado) { // si ocupado es 0 está libre
            index = i;
            break;
        }
    }

    // Si no hay espacio disponible
    if (index == -1) {
        printf("No se pueden agregar más libros (max 10).\n");
        return;
    }

    int id;
    printf("Ingrese ID del libro: ");
    scanf("%d", &id);
    getchar(); // limpiar buffer

    // Validación: el ID debe ser único
    if (existeID(libros, id)) {
        printf("ERROR: Ese ID ya existe.\n");
        return;
    }

    libros[index].id = id;

    // Ingreso del título
    printf("Ingrese título: ");
    fgets(libros[index].titulo, 100, stdin);
    libros[index].titulo[strcspn(libros[index].titulo, "\n")] = 0; // quitar salto

    // Ingreso del autor
    printf("Ingrese autor: ");
    fgets(libros[index].autor, 50, stdin);
    libros[index].autor[strcspn(libros[index].autor, "\n")] = 0;

    // Año
    printf("Ingrese año de publicación: ");
    scanf("%d", &libros[index].anio);
    getchar();

    // Estado inicial
    strcpy(libros[index].estado, "Disponible");

    // Marcar como ocupado
    libros[index].ocupado = 1;

    printf("Libro agregado correctamente.\n");
}


// Muestra todos los libros ocupados en formato tabla.
void mostrarLibros(Libro *libros) {
    printf("\n%-5s %-30s %-20s %-6s %-12s\n", "ID", "Título", "Autor", "Año", "Estado");
    printf("-------------------------------------------------------------------------------\n");

    int vacio = 1;

    for (int i = 0; i < MAX_LIBROS; i++) {
        if (libros[i].ocupado) {
            vacio = 0;
            printf("%-5d %-30s %-20s %-6d %-12s\n",
                   libros[i].id,
                   libros[i].titulo,
                   libros[i].autor,
                   libros[i].anio,
                   libros[i].estado);
        }
    }

    if (vacio)
        printf("No hay libros registrados.\n");
}


// Permite buscar un libro por ID o por título.
void buscarLibro(Libro *libros) {
    int opcion;

    printf("Buscar por:\n1. ID\n2. Título\nOpción: ");
    scanf("%d", &opcion);
    getchar();

  
    if (opcion == 1) {
        int id;
        printf("Ingrese ID: ");
        scanf("%d", &id);

        for (int i = 0; i < MAX_LIBROS; i++) {
            if (libros[i].ocupado && libros[i].id == id) {
                printf("\nLibro encontrado:\n");
                printf("ID: %d\n", libros[i].id);
                printf("Título: %s\n", libros[i].titulo);
                printf("Autor: %s\n", libros[i].autor);
                printf("Año: %d\n", libros[i].anio);
                printf("Estado: %s\n", libros[i].estado);
                return;
            }
        }
        printf("No se encontró el libro.\n");
    }

    else if (opcion == 2) {
        char titulo[100];
        printf("Ingrese título: ");
        fgets(titulo, 100, stdin);
        titulo[strcspn(titulo, "\n")] = 0;

        for (int i = 0; i < MAX_LIBROS; i++) {
            if (libros[i].ocupado && strcmp(libros[i].titulo, titulo) == 0) {
                printf("\nLibro encontrado:\n");
                printf("ID: %d\n", libros[i].id);
                printf("Título: %s\n", libros[i].titulo);
                printf("Autor: %s\n", libros[i].autor);
                printf("Año: %d\n", libros[i].anio);
                printf("Estado: %s\n", libros[i].estado);
                return;
            }
        }

        printf("No se encontró el libro.\n");
    }
}


// Cambia el estado entre "Disponible" y "Prestado".
void actualizarEstado(Libro *libros) {
    int id;
    printf("Ingrese ID del libro: ");
    scanf("%d", &id);

    for (int i = 0; i < MAX_LIBROS; i++) {
        if (libros[i].ocupado && libros[i].id == id) {

            // Cambiar estado
            if (strcmp(libros[i].estado, "Disponible") == 0)
                strcpy(libros[i].estado, "Prestado");
            else
                strcpy(libros[i].estado, "Disponible");

            printf("Estado actualizado.\n");
            return;
        }
    }

    printf("No se encontró el libro.\n");
}


// Eliminación lógica: simplemente marca la posición como vacía.
void eliminarLibro(Libro *libros) {
    int id;
    printf("Ingrese ID del libro a eliminar: ");
    scanf("%d", &id);

    for (int i = 0; i < MAX_LIBROS; i++) {
        if (libros[i].ocupado && libros[i].id == id) {
            libros[i].ocupado = 0; // marcar como no ocupado
            printf("Libro eliminado.\n");
            return;
        }
    }

    printf("No se encontró el libro.\n");
}
